<!DOCTYPE html>

<html>
<head>
  <title>Paperboy</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1 id="paperboy">Paperboy</h1>
<h3 id="an-intersystem-communicator">An intersystem communicator</h3>
<p><img src="https://media.giphy.com/media/eoUwc3wSwDOvK/giphy.gif" alt="gif"></p>
<p><strong>Example:</strong> Paperboy can be used for data storage</p>
<pre><code><span class="hljs-keyword">const</span> Paperboy = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./library/paperboy`</span>);
<span class="hljs-keyword">const</span> paperboy = <span class="hljs-keyword">new</span> Paperboy({<span class="hljs-attr">connectionName</span>: <span class="hljs-string">`data-example`</span>});
paperboy.push(<span class="hljs-string">`example`</span>, <span class="hljs-string">`Hello World!`</span>);
paperboy.pull(<span class="hljs-string">`example`</span>)
 .then(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
   <span class="hljs-built_in">console</span>.log(result); <span class="hljs-comment">// "Hello World!" is logged to the console</span>
 });
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>Example:</strong> Paperboy can be used as a publish/subscribe service</p>
<pre><code><span class="hljs-keyword">const</span> Paperboy = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./library/paperboy`</span>);
<span class="hljs-keyword">const</span> paperboy = <span class="hljs-keyword">new</span> Paperboy({<span class="hljs-attr">connectionName</span>: <span class="hljs-string">`pubsub-example`</span>});
paperboy.on(<span class="hljs-string">`my-event`</span>, (data) =&gt; {
  <span class="hljs-built_in">console</span>.log(data); <span class="hljs-comment">// "Hello World!" is logged to the console</span>
});

paperboy.trigger(<span class="hljs-string">`my-event`</span>, <span class="hljs-string">`Hello World!`</span>);
</code></pre><hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Paperboy loads modules it depends on to operate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> { <span class="hljs-attr">ioredis</span>:Redis, <span class="hljs-string">'generic-pool'</span>: genericPool, dotenv } = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./dependencies`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Paperboy adds the <code>.env file</code> variables to the process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>dotenv.config();</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Paperboy loads the native event emitter module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">`events`</span>);
<span class="hljs-keyword">const</span> { exec }     = <span class="hljs-built_in">require</span>(<span class="hljs-string">`child_process`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Paperboy creates an event metter using the native event emitter module</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaperboyEventEmitter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span> </span>{}
<span class="hljs-keyword">const</span> paperboyEvent = <span class="hljs-keyword">new</span> PaperboyEventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h4 id="paperboy-can-create-a-redis-connection-pool">Paperboy can create a Redis connection pool</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">const</span> createRedisConnectionPool = <span class="hljs-function">(<span class="hljs-params">{connectionName = <span class="hljs-string">`unnamed-connection`</span>} = {}, poolType = <span class="hljs-string">`generic`</span></span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>Scenario:</strong> The system requests a Redis connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> genericPool.createPool({</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><strong>Given</strong> the connection pool needs to create a new Redis connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    create: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><strong>And</strong> the connection sets its url and name</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> getUrlAndConnectionName = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
          resolve({
            <span class="hljs-attr">connectionName</span>: <span class="hljs-string">`@<span class="hljs-subst">${connectionName}</span>-<span class="hljs-subst">${poolType}</span>`</span>,
            <span class="hljs-attr">url</span>           : process.env.PAPERBOY_REDIS_URL
          });
        });
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><strong>And</strong> the connection is made</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> createRedisConnection = <span class="hljs-function">(<span class="hljs-params">{connectionName, url}</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
          <span class="hljs-keyword">const</span> connection = <span class="hljs-keyword">new</span> Redis(url, {connectionName, <span class="hljs-attr">enableReadyCheck</span>: <span class="hljs-literal">true</span>});
          resolve(connection);
        });
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><strong>And</strong> the connection can listen to messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> listenForMessages = <span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
          connection.on(<span class="hljs-string">`message`</span>, (channel, message) =&gt; {
            paperboyEvent.emit(channel, message);
          });
          
          resolve(connection);
        });
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><strong>And</strong> the connection can listen to errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> listenForErrors = <span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> execRan = <span class="hljs-literal">false</span>;
          connection.on(<span class="hljs-string">`error`</span>, ({address, port}) =&gt; {
            <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-string">`paperboy-communicator can't connect to <span class="hljs-subst">${address}</span>:<span class="hljs-subst">${port}</span>`</span>;
            <span class="hljs-built_in">console</span>.error(errorMessage);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><em>Do not try to start redis if it has already been tried</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(execRan) <span class="hljs-keyword">return</span>;
            execRan = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <ul>
<li>Check if the address is local</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(address === <span class="hljs-string">`127.0.0.1`</span>) {
              <span class="hljs-keyword">const</span> platform  = process.platform;
              <span class="hljs-keyword">let</span> execCommand = <span class="hljs-string">`sudo service redis-server start`</span>;
              
              <span class="hljs-keyword">if</span>(platform === <span class="hljs-string">`win32`</span>) <span class="hljs-keyword">return</span>;
              <span class="hljs-keyword">if</span>(platform === <span class="hljs-string">`darwin`</span>) execCommand = <span class="hljs-string">`brew services start redis`</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <ul>
<li>Start the local Redis server</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>              exec(execCommand, (err, stdout, stderr) =&gt; {
                <span class="hljs-keyword">if</span> (err) {
                  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`Could not start redis on <span class="hljs-subst">${address}</span>:<span class="hljs-subst">${port}</span>`</span>);
                  <span class="hljs-keyword">return</span>;
                }
                
                <span class="hljs-keyword">if</span>(stdout){
                  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`paperboy-communicator stdout: <span class="hljs-subst">${stdout}</span>`</span>);
                }
                
                <span class="hljs-keyword">if</span>(stderr){
                  <span class="hljs-built_in">console</span>.info(<span class="hljs-string">`paperboy-communicator stderr: <span class="hljs-subst">${stderr}</span>`</span>);
                }
              });
            }
          });</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <ul>
<li>Continue if the connection is ready</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>          connection.on(<span class="hljs-string">`ready`</span>, () =&gt; {
            resolve(connection);
          });
        });
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><strong>And</strong> the creation method will return the new connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> getUrlAndConnectionName()
        .then(createRedisConnection)
        .then(listenForMessages)
        .then(listenForErrors);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p><strong>Given</strong> the connection pool needs to destroy a connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    destroy: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">connection</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><strong>Then</strong> the connection pool will returns the connection <em>(it does not destroy it yet)</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.resolve(connection);
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The connection pool has settings</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }, {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <ul>
<li>The connection pool has a minimum number of connections set to <code>0</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    min: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <ul>
<li>The connection pool has a maximum number of connections set to <code>1</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    max: <span class="hljs-number">1</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <ul>
<li>The connection pool automatically creates one connection</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>    autostart: <span class="hljs-literal">true</span>
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <h4 id="the-paperboy-module-is-a-class">The Paperboy module is a class</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-built_in">module</span>.exports = <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Paperboy</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Paperboy creates pools of connections for <code>data</code> operations and <code>triggering</code>, and <code>subscribing</code> to events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">constructor</span>(options = {}) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Paperboy has <code>3</code> Redis connection pools</p>
<blockquote>
<p>Redis connections in subscriber mode can <em>not</em> trigger events or modify data!
<a href="https://github.com/luin/ioredis">source</a></p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.pool = {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <ul>
<li>Paperboy has a connection pool for data operations</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      data     : createRedisConnectionPool(options, <span class="hljs-string">`data`</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <ul>
<li>Paperboy has a connection pool for triggering events</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      trigger  : createRedisConnectionPool(options, <span class="hljs-string">`trigger`</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <ul>
<li>Paperboy has a connection pool for subscribing to events</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      subscribe: createRedisConnectionPool(options, <span class="hljs-string">`subscribe`</span>)
    };

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h4 id="paperboy-can-store-data">Paperboy can store data</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  push(key, value, args, details) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <ul>
<li>Data without a key is rejected</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!key) <span class="hljs-keyword">return</span> reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`no key`</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <ul>
<li>Data without a value is rejected</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!value) <span class="hljs-keyword">return</span> reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`no value`</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Paperboy creates a copy of the data to send as a reply</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> reply = {};
      reply[key] = value;</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Paperboy can release the <code>data</code> connection back into the <a href="#section-8">connection pool</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> releaseConnection = <span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> <span class="hljs-keyword">this</span>.pool.data.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p><strong>Given</strong> there are no special requirements to store the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!args &amp;&amp; !details){</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p><strong>When</strong> a connection is acquired from the <code>data</code> connection pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pool.data.acquire()
          .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p><strong>Then</strong> Paperboy will store the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            connection.set(key, value)
              .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will release the Redis data connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                releaseConnection(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return a copy of the data that was stored</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                resolve(reply);
              })
              .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p><strong>But</strong> Paperboy will release the connection when there are errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                releaseConnection(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the error that was caught</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                reject(error);
              });
          })</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Paperboy will reject pushed data if there is a problem acquiring a connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          .catch(reject);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p><strong>Given</strong> there are special requirements to store the data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.pool.data.acquire()
        .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p><strong>Then</strong> Paperboy will store the data using the special requirements</p>
<blockquote>
<p>Special requirements in this case is an expiration time!
<a href="https://redis.io/commands/set">source</a></p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>          connection.set(key, value, args, details)
            .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
              releaseConnection(connection);
              resolve(reply);
            })
            .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
              releaseConnection(connection);
              reject(error);
            });
        })
        .catch(reject);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <h4 id="paperboy-can-retrieve-data">Paperboy can retrieve data</h4>
<ul>
<li>The data can be retrieved by the name of the <code>key</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pull(key) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p><strong>Given</strong> a connection is acquired from the <code>data</code> connection pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.pool.data.acquire()
      .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p><strong>When</strong> Paperboy retrieves the data by the name of the <code>key</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> connection.get(key)
          .then(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p><strong>Then</strong> Paperboy will release the connection into the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.pool.data.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the data that was retrieved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> data;
          })
          .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p><strong>But</strong> Paperboy will release the connection if there was an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">this</span>.pool.data.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the error that was caught</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">return</span> error;
          });
      });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h4 id="paperboy-can-remove-data">Paperboy can remove data</h4>
<ul>
<li>Data can be removed by the name of the <code>key</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>  remove(key) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <ul>
<li>Removal requests without a key are rejected</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!key) <span class="hljs-keyword">return</span> reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`no key`</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p><strong>Given</strong> a connection is acquired from the <code>data</code> connection pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.pool.data.acquire()
        .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p><strong>When</strong> Paperboy removes the data using the key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> connection.del(key)
            .then(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p><strong>Then</strong> Paperboy will release the connection into the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">this</span>.pool.data.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the data that was removed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">return</span> data;
            })
            .then(resolve)
            .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p><strong>But</strong> Paperboy will release the connection if there was an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">this</span>.pool.data.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the error that was caught</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              reject(error);
            });
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Paperboy will reject deleted data if there is a problem acquiring a connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .catch(reject);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h4 id="paperboy-can-subscribe-to-an-event-once">Paperboy can subscribe to an event once</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  once(event, callback) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Paperboy can release <code>subscribe</code> connections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> releaseConnection = <span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> <span class="hljs-keyword">this</span>.pool.subscribe.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p><strong>Given</strong> a connection is acquired from the <code>subscribe</code> connection pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.pool.subscribe.acquire()
        .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy listens to the event once</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          paperboyEvent.once(event, callback);</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p><strong>Then</strong> the connection subscribes to the event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          connection.subscribe(event, (error) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p><strong>But</strong> Paperboy will reject the subscription request if there are errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(error) <span class="hljs-keyword">return</span> reject(error);</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will resolve without errors if the subscription was made successfully</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            resolve();
          });</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Paperboy will always release the connection into the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          releaseConnection(connection);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Paperboy will reject the subscription if there is a problem acquiring a connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .catch(reject);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <h4 id="paperboy-can-subscribe-to-an-event">Paperboy can subscribe to an event</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  on(event, callback) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Paperboy can release <code>subscribe</code> connections</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> releaseConnection = <span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> <span class="hljs-keyword">this</span>.pool.subscribe.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p><strong>Given</strong> a connection is acquired from the <code>subscribe</code> connection pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.pool.subscribe.acquire()
        .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy listens to the event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          paperboyEvent.on(event, callback);</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p><strong>Then</strong> the connection subscribes to the event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          connection.subscribe(event, (error) =&gt; {</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p><strong>But</strong> Paperboy will reject the subscription request if there are errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>(error) <span class="hljs-keyword">return</span> reject(error);</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will resolve without errors if the subscription was made successfully</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            resolve();
          });</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Paperboy will always release the connection into the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          releaseConnection(connection);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Paperboy will reject the subscription if there is a problem acquiring a connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .catch(reject);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <h4 id="paperboy-can-trigger-an-event">Paperboy can trigger an event</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  trigger(event, data) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <ul>
<li>Reject trigger calls that do not have an event </li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(!event) <span class="hljs-keyword">return</span> reject(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">`no event`</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p><strong>Given</strong> a connection is acquired from the <code>trigger</code> connection pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.pool.trigger.acquire()
        .then(<span class="hljs-function">(<span class="hljs-params">connection</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p><strong>When</strong> Paperboy publishes data for the event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          connection.publish(event, data)
            .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p><strong>Then</strong> Paperboy will release the connection into the pool</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">this</span>.pool.trigger.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the data that was triggered</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              resolve(data);
            })
            .catch(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p><strong>But</strong> Paperboy will release the connection intot he pool if there was an error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              <span class="hljs-keyword">this</span>.pool.trigger.release(connection);</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p><strong>And</strong> Paperboy will return the error that was caught</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>              reject(error);
            });
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Paperboy will reject the trigger request if there is a problem acquiring a connection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .catch(reject);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <h4 id="paperboy-can-remove-an-event-listener">Paperboy can remove an event listener</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removeListener(event, listener) {
    paperboyEvent.removeListener(event, listener);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <h4 id="paperboy-can-retrieve-the-number-of-listeners-for-an-event">Paperboy can retrieve the number of listeners for an event</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>  listenerCount(event) {
    <span class="hljs-keyword">return</span> paperboyEvent.listenerCount(event);
  }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
